name: Build Nova Compiler

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew update
        brew install llvm@18 cmake ninja
        echo "LLVM_DIR=$(brew --prefix llvm@18)/lib/cmake/llvm" >> $GITHUB_ENV
        echo "$(brew --prefix llvm@18)/bin" >> $GITHUB_PATH

    - name: Configure CMake
      run: |
        mkdir -p build/macos-${{ matrix.arch }}
        cd build/macos-${{ matrix.arch }}
        if [ "${{ matrix.arch }}" = "arm64" ]; then
          cmake -G Ninja \
            -DCMAKE_C_COMPILER=$(brew --prefix llvm@18)/bin/clang \
            -DCMAKE_CXX_COMPILER=$(brew --prefix llvm@18)/bin/clang++ \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DLLVM_DIR=$LLVM_DIR \
            ../..
        else
          cmake -G Ninja \
            -DCMAKE_C_COMPILER=$(brew --prefix llvm@18)/bin/clang \
            -DCMAKE_CXX_COMPILER=$(brew --prefix llvm@18)/bin/clang++ \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DLLVM_DIR=$LLVM_DIR \
            ../..
        fi

    - name: Build
      run: |
        cd build/macos-${{ matrix.arch }}
        ninja nova

    - name: Test executable
      run: |
        ./build/macos-${{ matrix.arch }}/nova --version

    - name: Package binary
      run: |
        mkdir -p dist
        cp build/macos-${{ matrix.arch }}/nova dist/nova-macos-${{ matrix.arch }}
        chmod +x dist/nova-macos-${{ matrix.arch }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: nova-macos-${{ matrix.arch }}
        path: dist/nova-macos-${{ matrix.arch }}
        retention-days: 30

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-18 \
          llvm-18 \
          llvm-18-dev \
          cmake \
          ninja-build \
          libc++-18-dev \
          libc++abi-18-dev
        echo "LLVM_DIR=/usr/lib/llvm-18/lib/cmake/llvm" >> $GITHUB_ENV

    - name: Configure CMake
      run: |
        mkdir -p build/linux-x64
        cd build/linux-x64
        cmake -G Ninja \
          -DCMAKE_C_COMPILER=clang-18 \
          -DCMAKE_CXX_COMPILER=clang++-18 \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_DIR=$LLVM_DIR \
          ../..

    - name: Build
      run: |
        cd build/linux-x64
        ninja nova

    - name: Test executable
      run: |
        ./build/linux-x64/nova --version

    - name: Package binary
      run: |
        mkdir -p dist
        cp build/linux-x64/nova dist/nova-linux-x64
        chmod +x dist/nova-linux-x64

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: nova-linux-x64
        path: dist/nova-linux-x64
        retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup LLVM
      run: |
        $llvmUrl = "https://github.com/llvm/llvm-project/releases/download/llvmorg-18.1.7/clang+llvm-18.1.7-x86_64-pc-windows-msvc.tar.xz"
        $llvmDir = "C:\LLVM"

        Write-Host "Downloading LLVM..."
        Invoke-WebRequest -Uri $llvmUrl -OutFile llvm.tar.xz

        Write-Host "Extracting .tar.xz to .tar..."
        7z x llvm.tar.xz -y

        Write-Host "Listing all files..."
        Get-ChildItem . -File

        Write-Host "Finding .tar file..."
        $tarFile = Get-ChildItem . -File | Where-Object Name -like "*.tar" | Select-Object -First 1

        if (-not $tarFile) {
          throw "No .tar file found after extracting .tar.xz"
        }

        Write-Host "Extracting $($tarFile.Name) to C:\..."
        7z x $tarFile.FullName -o"C:\" -y

        Write-Host "Checking extracted directory..."
        Get-ChildItem C:\ -Directory | Where-Object Name -like "*llvm*"

        if (Test-Path "C:\clang+llvm-18.1.7-x86_64-pc-windows-msvc") {
          Rename-Item -Path "C:\clang+llvm-18.1.7-x86_64-pc-windows-msvc" -NewName "LLVM"
        } else {
          Write-Host "Directory not found, trying to find it..."
          $llvmExtracted = Get-ChildItem C:\ -Directory | Where-Object Name -like "*clang+llvm*" | Select-Object -First 1
          if ($llvmExtracted) {
            Rename-Item -Path $llvmExtracted.FullName -NewName "LLVM"
          } else {
            throw "LLVM directory not found after extraction"
          }
        }

        echo "$llvmDir\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "LLVM_DIR=$llvmDir\lib\cmake\llvm" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Setup Build Tools
      uses: microsoft/setup-msbuild@v2

    - name: Install Ninja
      run: choco install ninja -y

    - name: Setup DIA SDK stub
      shell: pwsh
      run: |
        # Check if diaguids.lib exists
        $diaPath = "C:/Program Files (x86)/Microsoft Visual Studio/2019/Professional/DIA SDK/lib/amd64"
        Write-Host "Checking for DIA SDK at: $diaPath"

        if (-not (Test-Path "$diaPath/diaguids.lib")) {
          Write-Host "DIA SDK not found. Creating stub library..."

          # Create directory structure
          New-Item -ItemType Directory -Force -Path $diaPath

          # Create an empty object file first
          $tempObj = "temp_empty.obj"
          $tempAsm = "temp_empty.asm"

          # Create minimal assembly file
          Set-Content -Path $tempAsm -Value "section .text`nglobal _dummy`n_dummy:`nret"

          # Try to use LLVM's tools to create library
          if (Test-Path "C:/LLVM/bin/llvm-mc.exe") {
            Write-Host "Using LLVM tools to create stub library..."
            # Create object file and then library
            & "C:/LLVM/bin/clang.exe" -c -x assembler $tempAsm -o $tempObj
            & "C:/LLVM/bin/llvm-lib.exe" /OUT:"$diaPath/diaguids.lib" $tempObj
            Remove-Item $tempObj, $tempAsm -ErrorAction SilentlyContinue
          } else {
            Write-Host "LLVM tools not found, creating minimal stub..."
            # Fallback: create minimal valid library file
            # This is a minimal COFF library header
            $bytes = @(
              0x21, 0x3C, 0x61, 0x72, 0x63, 0x68, 0x3E, 0x0A,  # !<arch>.
              0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,  # padding
              0x20, 0x20, 0x20, 0x20, 0x30, 0x20, 0x20, 0x20,
              0x20, 0x20, 0x20, 0x20, 0x30, 0x20, 0x20, 0x20,
              0x20, 0x20, 0x20, 0x20, 0x30, 0x20, 0x20, 0x20,
              0x20, 0x20, 0x20, 0x20, 0x30, 0x20, 0x20, 0x20,
              0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x60, 0x0A
            )
            [System.IO.File]::WriteAllBytes("$diaPath/diaguids.lib", $bytes)
          }

          Write-Host "Created stub diaguids.lib at: $diaPath/diaguids.lib"
        } else {
          Write-Host "DIA SDK library found at: $diaPath/diaguids.lib"
        }

    - name: Configure CMake
      shell: pwsh
      run: |
        # Clean build directory to avoid cached DIA SDK dependencies
        if (Test-Path build/windows-x64) {
          Remove-Item -Recurse -Force build/windows-x64
        }
        mkdir -p build/windows-x64
        cd build/windows-x64
        cmake -G Ninja `
          -DCMAKE_C_COMPILER="C:/LLVM/bin/clang.exe" `
          -DCMAKE_CXX_COMPILER="C:/LLVM/bin/clang++.exe" `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_CXX_FLAGS="-D_ALLOW_COMPILER_AND_STL_VERSION_MISMATCH" `
          -DLLVM_DIR="C:/LLVM/lib/cmake/llvm" `
          -DLLVM_ENABLE_DIA_SDK=OFF `
          ../..

    - name: Build
      shell: pwsh
      run: |
        cd build/windows-x64
        ninja nova

    - name: Test executable
      shell: pwsh
      run: |
        ./build/windows-x64/nova.exe --version

    - name: Package binary
      shell: pwsh
      run: |
        mkdir -p dist
        cp build/windows-x64/nova.exe dist/nova-windows-x64.exe

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: nova-windows-x64
        path: dist/nova-windows-x64.exe
        retention-days: 30

  create-release:
    name: Create Release
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/nova-macos-x64/nova-macos-x64
          artifacts/nova-macos-arm64/nova-macos-arm64
          artifacts/nova-linux-x64/nova-linux-x64
          artifacts/nova-windows-x64/nova-windows-x64.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
