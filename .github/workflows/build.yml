name: Build Nova Compiler

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew update
        brew install llvm@18 cmake ninja
        echo "LLVM_DIR=$(brew --prefix llvm@18)/lib/cmake/llvm" >> $GITHUB_ENV
        echo "$(brew --prefix llvm@18)/bin" >> $GITHUB_PATH

    - name: Configure CMake
      run: |
        mkdir -p build/macos-${{ matrix.arch }}
        cd build/macos-${{ matrix.arch }}

        # Get LLVM prefix from Homebrew
        LLVM_PREFIX=$(brew --prefix llvm@18)

        # Fix header search path - LLVM headers must come before system headers
        # Find the actual clang version directory
        CLANG_VERSION=$(ls ${LLVM_PREFIX}/lib/clang/ | head -1)
        BASE_CXX_FLAGS="-nostdinc++ -isystem ${LLVM_PREFIX}/lib/clang/${CLANG_VERSION}/include -isystem ${LLVM_PREFIX}/include/c++/v1"

        if [ "${{ matrix.arch }}" = "arm64" ]; then
          # Native ARM64 build - use armv8-a
          CXX_FLAGS="${BASE_CXX_FLAGS} -march=armv8-a"
          cmake -G Ninja \
            -DCMAKE_C_COMPILER=${LLVM_PREFIX}/bin/clang \
            -DCMAKE_CXX_COMPILER=${LLVM_PREFIX}/bin/clang++ \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_CXX_FLAGS="${CXX_FLAGS}" \
            -DLLVM_DIR=$LLVM_DIR \
            ../..
        else
          # Cross-compile for x86_64 on ARM64 runner - use x86-64-v2
          CXX_FLAGS="${BASE_CXX_FLAGS} -march=x86-64-v2"
          cmake -G Ninja \
            -DCMAKE_C_COMPILER=${LLVM_PREFIX}/bin/clang \
            -DCMAKE_CXX_COMPILER=${LLVM_PREFIX}/bin/clang++ \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_CXX_FLAGS="${CXX_FLAGS}" \
            -DLLVM_DIR=$LLVM_DIR \
            ../..
        fi

    - name: Build
      run: |
        cd build/macos-${{ matrix.arch }}
        ninja nova

    - name: Test executable
      run: |
        ./build/macos-${{ matrix.arch }}/nova --version

    - name: Package binary
      run: |
        mkdir -p dist
        cp build/macos-${{ matrix.arch }}/nova dist/nova-macos-${{ matrix.arch }}
        chmod +x dist/nova-macos-${{ matrix.arch }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: nova-macos-${{ matrix.arch }}
        path: dist/nova-macos-${{ matrix.arch }}
        retention-days: 30

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-18 \
          llvm-18 \
          llvm-18-dev \
          cmake \
          ninja-build \
          libc++-18-dev \
          libc++abi-18-dev
        echo "LLVM_DIR=/usr/lib/llvm-18/lib/cmake/llvm" >> $GITHUB_ENV

    - name: Configure CMake
      run: |
        mkdir -p build/linux-x64
        cd build/linux-x64
        cmake -G Ninja \
          -DCMAKE_C_COMPILER=clang-18 \
          -DCMAKE_CXX_COMPILER=clang++-18 \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_DIR=$LLVM_DIR \
          ../..

    - name: Build
      run: |
        cd build/linux-x64
        ninja nova

    - name: Test executable
      run: |
        ./build/linux-x64/nova --version

    - name: Package binary
      run: |
        mkdir -p dist
        cp build/linux-x64/nova dist/nova-linux-x64
        chmod +x dist/nova-linux-x64

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: nova-linux-x64
        path: dist/nova-linux-x64
        retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup LLVM
      run: |
        $llvmUrl = "https://github.com/llvm/llvm-project/releases/download/llvmorg-18.1.7/clang+llvm-18.1.7-x86_64-pc-windows-msvc.tar.xz"
        $llvmDir = "C:\LLVM"

        Write-Host "Downloading LLVM..."
        Invoke-WebRequest -Uri $llvmUrl -OutFile llvm.tar.xz

        Write-Host "Extracting .tar.xz to .tar..."
        7z x llvm.tar.xz -y

        Write-Host "Listing all files..."
        Get-ChildItem . -File

        Write-Host "Finding .tar file..."
        $tarFile = Get-ChildItem . -File | Where-Object Name -like "*.tar" | Select-Object -First 1

        if (-not $tarFile) {
          throw "No .tar file found after extracting .tar.xz"
        }

        Write-Host "Extracting $($tarFile.Name) to C:\..."
        7z x $tarFile.FullName -o"C:\" -y

        Write-Host "Checking extracted directory..."
        Get-ChildItem C:\ -Directory | Where-Object Name -like "*llvm*"

        if (Test-Path "C:\clang+llvm-18.1.7-x86_64-pc-windows-msvc") {
          Rename-Item -Path "C:\clang+llvm-18.1.7-x86_64-pc-windows-msvc" -NewName "LLVM"
        } else {
          Write-Host "Directory not found, trying to find it..."
          $llvmExtracted = Get-ChildItem C:\ -Directory | Where-Object Name -like "*clang+llvm*" | Select-Object -First 1
          if ($llvmExtracted) {
            Rename-Item -Path $llvmExtracted.FullName -NewName "LLVM"
          } else {
            throw "LLVM directory not found after extraction"
          }
        }

        echo "$llvmDir\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "LLVM_DIR=$llvmDir\lib\cmake\llvm" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Setup Build Tools
      uses: microsoft/setup-msbuild@v2

    - name: Install Ninja
      run: choco install ninja -y

    - name: Setup DIA SDK library
      shell: pwsh
      run: |
        # Target path where LLVM expects diaguids.lib
        $targetPath = "C:/Program Files (x86)/Microsoft Visual Studio/2019/Professional/DIA SDK/lib/amd64"
        $targetFile = "$targetPath/diaguids.lib"

        Write-Host "Checking for DIA SDK at: $targetPath"

        if (-not (Test-Path $targetFile)) {
          Write-Host "DIA SDK not found at target location. Searching for diaguids.lib..."

          # Search for diaguids.lib in common locations
          $searchPaths = @(
            "C:/Program Files (x86)/Microsoft Visual Studio",
            "C:/Program Files/Microsoft Visual Studio",
            "C:/Program Files (x86)/Windows Kits",
            "C:/Program Files/Windows Kits"
          )

          $foundLib = $null
          foreach ($searchPath in $searchPaths) {
            Write-Host "Searching in: $searchPath"
            if (Test-Path $searchPath) {
              $foundLib = Get-ChildItem -Path $searchPath -Filter "diaguids.lib" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($foundLib) {
                Write-Host "Found diaguids.lib at: $($foundLib.FullName)"
                break
              }
            }
          }

          if ($foundLib) {
            Write-Host "Copying diaguids.lib from $($foundLib.FullName) to $targetFile"
            New-Item -ItemType Directory -Force -Path $targetPath | Out-Null
            Copy-Item -Path $foundLib.FullName -Destination $targetFile -Force
            Write-Host "Successfully copied diaguids.lib"
          } else {
            Write-Host "diaguids.lib not found anywhere. Creating stub library..."

            # Create directory structure
            New-Item -ItemType Directory -Force -Path $targetPath | Out-Null

            # Try to use LLVM's tools to create library
            if (Test-Path "C:/LLVM/bin/llvm-lib.exe") {
              Write-Host "Using LLVM tools to create stub library..."
              $tempObj = "temp_empty.obj"
              $tempAsm = "temp_empty.asm"

              # Create minimal assembly file
              Set-Content -Path $tempAsm -Value "section .text`nglobal _dummy`n_dummy:`nret"

              & "C:/LLVM/bin/clang.exe" -c -x assembler $tempAsm -o $tempObj 2>&1 | Out-Null
              & "C:/LLVM/bin/llvm-lib.exe" /OUT:"$targetFile" $tempObj 2>&1 | Out-Null
              Remove-Item $tempObj, $tempAsm -ErrorAction SilentlyContinue

              Write-Host "Created stub diaguids.lib using LLVM tools"
            } else {
              Write-Host "Creating minimal COFF library..."
              # Minimal COFF library header
              $bytes = @(
                0x21, 0x3C, 0x61, 0x72, 0x63, 0x68, 0x3E, 0x0A,
                0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
                0x20, 0x20, 0x20, 0x20, 0x30, 0x20, 0x20, 0x20,
                0x20, 0x20, 0x20, 0x20, 0x30, 0x20, 0x20, 0x20,
                0x20, 0x20, 0x20, 0x20, 0x30, 0x20, 0x20, 0x20,
                0x20, 0x20, 0x20, 0x20, 0x30, 0x20, 0x20, 0x20,
                0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x60, 0x0A
              )
              [System.IO.File]::WriteAllBytes($targetFile, $bytes)
              Write-Host "Created minimal stub diaguids.lib"
            }
          }
        } else {
          Write-Host "DIA SDK library already exists at: $targetFile"
        }

    - name: Configure CMake
      shell: pwsh
      run: |
        # Clean build directory to avoid cached DIA SDK dependencies
        if (Test-Path build/windows-x64) {
          Remove-Item -Recurse -Force build/windows-x64
        }
        mkdir -p build/windows-x64
        cd build/windows-x64
        cmake -G Ninja `
          -DCMAKE_C_COMPILER="C:/LLVM/bin/clang.exe" `
          -DCMAKE_CXX_COMPILER="C:/LLVM/bin/clang++.exe" `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_CXX_FLAGS="-D_ALLOW_COMPILER_AND_STL_VERSION_MISMATCH" `
          -DLLVM_DIR="C:/LLVM/lib/cmake/llvm" `
          -DLLVM_ENABLE_DIA_SDK=OFF `
          ../..

    - name: Build
      shell: pwsh
      run: |
        cd build/windows-x64
        ninja nova

    - name: Test executable
      shell: pwsh
      run: |
        ./build/windows-x64/nova.exe --version

    - name: Package binary
      shell: pwsh
      run: |
        mkdir -p dist
        cp build/windows-x64/nova.exe dist/nova-windows-x64.exe

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: nova-windows-x64
        path: dist/nova-windows-x64.exe
        retention-days: 30

  create-release:
    name: Create Release
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/nova-macos-x64/nova-macos-x64
          artifacts/nova-macos-arm64/nova-macos-arm64
          artifacts/nova-linux-x64/nova-linux-x64
          artifacts/nova-windows-x64/nova-windows-x64.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
